# Документация функционального блока FB_UniversalAnalogSignal

## Обзор

### Назначение

Функциональный блок `FB_UniversalAnalogSignal` является универсальным решением для обработки аналоговых сигналов различных типов. Блок наследуется от `FB_BasicAnalogSignal` и обеспечивает гибкое масштабирование входного сигнала с любого диапазона в заданные инженерные единицы, а также предоставляет расширенную диагностику с настраиваемыми порогами.

## Интерфейс функционального блока

### Входные параметры (VAR_INPUT)

|Параметр|Тип данных|По умолчанию|Описание|
|---|---|---|---|
|`irRawValue`|`REAL`|-|Исходное аналоговое значение (наследуется)|
|`rInputMin`|`REAL`|0.0|Минимальное значение входного сигнала|
|`rInputMax`|`REAL`|10.0|Максимальное значение входного сигнала|
|`rScaleMin`|`REAL`|0.0|Минимальное значение масштабированного диапазона|
|`rScaleMax`|`REAL`|100.0|Максимальное значение масштабированного диапазона|
|`xEnableRangeProtection`|`BOOL`|TRUE|Включение защиты от выхода за диапазон|
|`xEnableDiagnostics`|`BOOL`|TRUE|Включение диагностики сигнала|

### Внутренние переменные (VAR)

|Переменная|Тип данных|По умолчанию|Описание|
|---|---|---|---|
|`_xSignalUnderrange`|`BOOL`|FALSE|Сигнал ниже минимума входного диапазона|
|`_xSignalOverrange`|`BOOL`|FALSE|Сигнал выше максимума входного диапазона|
|`_rUnderrangeThreshold`|`REAL`|5.0|Порог критически низкого сигнала (%)|
|`_rOverrangeThreshold`|`REAL`|5.0|Порог критически высокого сигнала (%)|
|`_xCriticalLow`|`BOOL`|FALSE|Критически низкий сигнал|
|`_xCriticalHigh`|`BOOL`|FALSE|Критически высокий сигнал|
|`_rNormalizedValue`|`REAL`|0.0|Нормализованное значение (0..1)|
|`_rPercentValue`|`REAL`|0.0|Процентное значение (0..100%)|

## Принцип работы

### Масштабирование сигнала

1. **Нормализация**: Входной сигнал приводится к диапазону 0-1 относительно входного диапазона
2. **Защита диапазона**: При включенной защите нормализованное значение ограничивается в пределах 0-1
3. **Масштабирование**: Нормализованное значение преобразуется в выходной инженерный диапазон

### Диагностика сигнала

1. **Базовая диагностика**: Проверка нахождения в пределах входного диапазона
2. **Расширенная диагностика**: Проверка критических отклонений с настраиваемыми порогами
3. **Вычисление дополнительных значений**: Процентные и нормализованные представления

## Методы

### Методы получения значений

#### GetScaledValue

**Описание:** Возвращает масштабированное значение с учетом критических ошибок.

**Прототип:**

```pascal
METHOD GetScaledValue : REAL
```

**Возвращаемое значение:**
- При критических ошибках → минимальное значение диапазона
- При нормальной работе → масштабированное значение

---

#### GetNormalizedValue

**Описание:** Возвращает нормализованное значение в диапазоне 0-1.

**Прототип:**

```pascal
METHOD GetNormalizedValue : REAL
```

**Возвращаемое значение:** Нормализованное значение (0.0 = минимум, 1.0 = максимум)

---

#### GetPercentValue

**Описание:** Возвращает процентное значение относительно масштабированного диапазона.

**Прототип:**

```pascal
METHOD GetPercentValue : REAL
```

**Возвращаемое значение:** Процентное значение (0..100%)

---

#### GetInputRangePercent

**Описание:** Возвращает процент относительно входного диапазона.

**Прототип:**

```pascal
METHOD GetInputRangePercent : REAL
```

**Возвращаемое значение:** Процент использования входного диапазона

### Методы диагностики

#### IsUnderrange / IsOverrange

**Описание:** Проверяют выход за пределы входного диапазона.

**Прототип:**

```pascal
METHOD IsUnderrange : BOOL
METHOD IsOverrange : BOOL
```

---

#### IsCriticalLow / IsCriticalHigh

**Описание:** Проверяют критические отклонения с учетом порогов.

**Прототип:**

```pascal
METHOD IsCriticalLow : BOOL
METHOD IsCriticalHigh : BOOL
```

---

#### HasError / HasCriticalError

**Описание:** Проверяют наличие ошибок различной критичности.

**Прототип:**

```pascal
METHOD HasError : BOOL          // Любые ошибки
METHOD HasCriticalError : BOOL  // Только критические ошибки
```

---

#### IsInValidRange

**Описание:** Проверяет нахождение в допустимом диапазоне.

**Прототип:**

```pascal
METHOD IsInValidRange : BOOL
```

### Методы настройки

#### SetInputRange / SetScaleRange

**Описание:** Устанавливают диапазоны входа и масштабирования.

**Прототип:**

```pascal
METHOD SetInputRange
VAR_INPUT
    rMin : REAL;
    rMax : REAL;
END_VAR

METHOD SetScaleRange
VAR_INPUT
    rMin : REAL;
    rMax : REAL;
END_VAR
```

---

#### SetDiagnosticThresholds

**Описание:** Устанавливает пороги критической диагностики.

**Прототип:**

```pascal
METHOD SetDiagnosticThresholds
VAR_INPUT
    rUnderrangePercent : REAL;  // Процент для критически низкого
    rOverrangePercent : REAL;   // Процент для критически высокого
END_VAR
```

### Методы быстрой конфигурации

#### ConfigureAs4_20mA

**Описание:** Конфигурация для токовой петли 4-20 мА.

**Прототип:**

```pascal
METHOD ConfigureAs4_20mA
VAR_INPUT
    rProcessMin : REAL := 0.0;
    rProcessMax : REAL := 100.0;
END_VAR
```

---

#### ConfigureAs0_10V

**Описание:** Конфигурация для сигнала 0-10В.

**Прототип:**

```pascal
METHOD ConfigureAs0_10V
VAR_INPUT
    rProcessMin : REAL := 0.0;
    rProcessMax : REAL := 100.0;
END_VAR
```

---

#### ConfigureAs0_20mA

**Описание:** Конфигурация для токового сигнала 0-20 мА.

**Прототип:**

```pascal
METHOD ConfigureAs0_20mA
VAR_INPUT
    rProcessMin : REAL := 0.0;
    rProcessMax : REAL := 100.0;
END_VAR
```

---

#### ConfigureAsPt100

**Описание:** Конфигурация для датчика температуры Pt100.

**Прототип:**

```pascal
METHOD ConfigureAsPt100
VAR_INPUT
    rTempMin : REAL := -50.0;
    rTempMax : REAL := 200.0;
END_VAR
```

### Методы получения информации

#### GetInputMin / GetInputMax

**Описание:** Возвращают границы входного диапазона.

**Прототип:**

```pascal
METHOD GetInputMin : REAL
METHOD GetInputMax : REAL
```

---

#### GetScaleMin / GetScaleMax

**Описание:** Возвращают границы масштабированного диапазона.

**Прототип:**

```pascal
METHOD GetScaleMin : REAL
METHOD GetScaleMax : REAL
```

---

#### GetInputSpan / GetScaleSpan

**Описание:** Возвращают размах соответствующих диапазонов.

**Прототип:**

```pascal
METHOD GetInputSpan : REAL
METHOD GetScaleSpan : REAL
```

## Типовые сценарии использования

### Универсальный аналоговый вход

```pascal
PROGRAM PRG_Main
VAR
    fbUniversalAI : FB_UniversalAnalogSignal;
    rAnalogInput : REAL;          // Вход от АЦП
    rProcessValue : REAL;         // Значение процесса
    xSignalValid : BOOL;          // Валидность сигнала
END_VAR

// Конфигурация для сигнала 0-10В, масштабирование в 0-100°C
fbUniversalAI.SetInputRange(0.0, 10.0);
fbUniversalAI.SetScaleRange(0.0, 100.0);
fbUniversalAI.SetDiagnosticThresholds(2.0, 2.0);

fbUniversalAI(
    irRawValue := rAnalogInput,
    xEnableRangeProtection := TRUE,
    xEnableDiagnostics := TRUE
);

// Получение результата
rProcessValue := fbUniversalAI.GetScaledValue();
xSignalValid := fbUniversalAI.IsInValidRange();
```

## Примечания

- Блок обеспечивает математически точное линейное масштабирование для любых диапазонов
- Автоматическая защита от некорректных диапазонов (когда Min >= Max)
- Критические пороги вычисляются как процент от входного диапазона
- При отключенной диагностике производительность блока повышается
- Нормализованное значение всегда в диапазоне 0-1 при включенной защите диапазона
- Блок поддерживает отрицательные диапазоны масштабирования (например, -100 до +100)
- Рекомендуется использовать быструю конфигурацию (`ConfigureAsXXX()`) для стандартных сигналов
- Для критичных по производительности применений рассмотрите специализированные блоки
- Регулярно контролируйте качество сигналов через диагностические методы
- При работе с зашумленными сигналами настройте соответствующие пороги диагностики
